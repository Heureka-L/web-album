<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全屏查看</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
        }

        .back-button {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .file-info {
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .viewer-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        .media-content {
            max-width: 90%;
            max-height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .media-content img,
        .media-content video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .nav-button {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .nav-button.left {
            left: 20px;
        }

        .nav-button.right {
            right: 20px;
        }

        .bottom-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
        }

        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px 50px;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .nav-button {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .nav-button.left {
                left: 10px;
            }

            .nav-button.right {
                right: 10px;
            }

            .file-info {
                font-size: 12px;
                padding: 8px 15px;
            }

            .back-button {
                font-size: 14px;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <button class="back-button" onclick="goBack()">
            <span>←</span>
            <span>返回</span>
        </button>
        <div class="file-info" id="fileInfo">加载中...</div>
    </div>

    <div class="viewer-container">
        <div class="media-content" id="mediaContent">
            <div class="loading">加载中...</div>
        </div>
    </div>

    <button class="nav-button left" onclick="prevMedia()">❮</button>
    <button class="nav-button right" onclick="nextMedia()">❯</button>

    <div class="bottom-bar" id="paginationInfo">1 / 1</div>

    <script>
        let currentIndex = 0;
        let mediaItems = [];
        let filePath = '';

        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                index: parseInt(params.get('index')) || 0,
                files: params.get('files') || '[]',
                path: params.get('path') || ''
            };
        }

        function loadMedia() {
            const params = getQueryParams();
            currentIndex = params.index;
            filePath = params.path;
            
            try {
                mediaItems = JSON.parse(decodeURIComponent(params.files));
            } catch {
                mediaItems = [];
            }

            if (mediaItems.length === 0) {
                showError('没有可查看的文件');
                return;
            }

            currentIndex = Math.max(0, Math.min(currentIndex, mediaItems.length - 1));
            displayMedia(currentIndex);
        }

        function displayMedia(index) {
            const item = mediaItems[index];
            const mediaContent = document.getElementById('mediaContent');
            const fileInfo = document.getElementById('fileInfo');
            const paginationInfo = document.getElementById('paginationInfo');

            if (!item) return;

            fileInfo.textContent = item.name;
            paginationInfo.textContent = `${index + 1} / ${mediaItems.length}`;

            const isImage = item.category === '图片';

            if (isImage) {
                const img = new Image();
                img.style.maxWidth = '90%';
                img.style.maxHeight = '90vh';
                img.onload = () => {
                    mediaContent.innerHTML = '';
                    mediaContent.appendChild(img);
                };
                img.onerror = () => {
                    showError('图片加载失败');
                };
                img.src = item.url;
            } else {
                mediaContent.innerHTML = `
                    <video style="max-width: 90%; max-height: 90vh;" controls autoplay>
                        <source src="${item.url}" type="video/mp4">
                        您的浏览器不支持视频播放
                    </video>
                `;
            }

            window.history.replaceState({ index: index }, '', `?index=${index}&files=${encodeURIComponent(JSON.stringify(mediaItems))}&path=${encodeURIComponent(filePath)}`);
        }

        function nextMedia() {
            if (currentIndex < mediaItems.length - 1) {
                currentIndex++;
                displayMedia(currentIndex);
            } else {
                showToast('已经是最后一个文件了');
            }
        }

        function prevMedia() {
            if (currentIndex > 0) {
                currentIndex--;
                displayMedia(currentIndex);
            } else {
                showToast('已经是第一个文件了');
            }
        }

        function goBack() {
            if (filePath) {
                window.location.href = `/?path=${encodeURIComponent(filePath)}`;
            } else {
                window.location.href = '/';
            }
        }

        function showError(message) {
            const mediaContent = document.getElementById('mediaContent');
            mediaContent.innerHTML = `<div class="error">${message}</div>`;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 200;
                animation: fadeIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'Escape':
                case 'Backspace':
                    e.preventDefault();
                    goBack();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    prevMedia();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextMedia();
                    break;
            }
        });

        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.index !== undefined) {
                displayMedia(e.state.index);
            }
        });

        window.addEventListener('load', () => {
            loadMedia();
        });
    </script>
</body>
</html>
